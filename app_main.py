import streamlit as st
import pandas as pd

# === –Ü–ú–ü–û–†–¢ –í–ê–®–ò–• –ú–û–î–£–õ–Ü–í ===
# –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—Å —î –ø–∞–ø–∫–∞ 'modules' —ñ –≤ –Ω—ñ–π –ª–µ–∂–∞—Ç—å —Ü—ñ —Ñ–∞–π–ª–∏
from modules import auth, patient_view, data_manager

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò (–ú–∞—î –±—É—Ç–∏ –Ω–∞–π–ø–µ—Ä—à–æ—é –∫–æ–º–∞–Ω–¥–æ—é)
st.set_page_config(
    page_title="–°–∫—Ä–∏–Ω—ñ–Ω–≥ –∑–¥–æ—Ä–æ–≤'—è 40+ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏",
    page_icon="üè•",
    layout="wide",
    initial_sidebar_state="expanded"
)

# 2. –°–ò–°–¢–ï–ú–ê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á
# –Ø–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–≤–µ—Ä—Ç–∞—î False, –∫–æ–¥ –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è —ñ –ø–æ–∫–∞–∑—É—î —Ç—ñ–ª—å–∫–∏ –≤—ñ–∫–Ω–æ –≤—Ö–æ–¥—É
if not auth.login_system():
    st.stop()

# ========================================================
# –î–ê–õ–Ü –ö–û–î –í–ò–ö–û–ù–£–Ñ–¢–¨–°–Ø –¢–Ü–õ–¨–ö–ò –î–õ–Ø –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ò–• –õ–Ü–ö–ê–†–Ü–í
# ========================================================

# 3. –ë–û–ö–û–í–ï –ú–ï–ù–Æ (–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ª—ñ–∫–∞—Ä—è + –í–∏—Ö—ñ–¥)
with st.sidebar:
    st.title("üë®‚Äç‚öïÔ∏è –ö–∞–±—ñ–Ω–µ—Ç –ª—ñ–∫–∞—Ä—è")
    st.write(f"–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫: **{st.session_state.get('user_name', '–õ—ñ–∫–∞—Ä')}**")
    st.write(f"–†–æ–ª—å: **{st.session_state.get('role', '–°–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç')}**")
    
    st.divider()
    # === –û–°–¨ –¶–Ø –ö–ù–û–ü–ö–ê ===
    # –í–æ–Ω–∞ –æ—á–∏—â—É—î –∫–µ—à (–∑–º—É—à—É—î –ø—Ä–æ–≥—Ä–∞–º—É –∑–∞–Ω–æ–≤–æ —Å–∫–∞—á–∞—Ç–∏ –¥–∞–Ω—ñ –∑ Google)
    # —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î —Å–∫—Ä–∏–ø—Ç, –Ω–µ –≥—É–±–ª—è—á–∏ –ª–æ–≥—ñ–Ω –ª—ñ–∫–∞—Ä—è
    if st.button("üîÑ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–æ–≤—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ", type="primary"):
        st.cache_data.clear()
        st.rerun()
        
    st.divider()
    if st.button("üö™ –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏", type="secondary"):
        # –û—á–∏—â–∞—î–º–æ —Å–µ—Å—ñ—é
        st.session_state['logged_in'] = False
        st.session_state['user_name'] = None
        st.rerun()
    
    st.divider()
    st.caption("¬© 2026 HealthPortal System")

# 4. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –¢–ê –û–ë–†–û–ë–ö–ê –î–ê–ù–ò–•
# –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –∑ –º–æ–¥—É–ª—è data_manager
st.title("–ì–æ–ª–æ–≤–Ω–∞ –ø–∞–Ω–µ–ª—å")

try:
    with st.spinner("üîÑ –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–≤—ñ–∂–∏—Ö –¥–∞–Ω–∏—Ö –∑ –±–∞–∑–∏ –ø–∞—Ü—ñ—î–Ω—Ç—ñ–≤..."):
        # –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –º–∞—î –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ 6 —Ñ–æ—Ä–º, –æ–±'—î–¥–Ω–∞—Ç–∏ —ó—Ö —ñ –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–∞–ª–∏
        df = data_manager.get_processed_data()
        
except Exception as e:
    st.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: {e}")
    st.stop()

# 5. –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –Ü–ù–¢–ï–†–§–ï–ô–°–£
# –ü–µ—Ä–µ–¥–∞—î–º–æ –≥–æ—Ç–æ–≤—É —Ç–∞–±–ª–∏—Ü—é —É –º–æ–¥—É–ª—å –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
if df.empty:
    st.info("üì≠ –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –ø–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—è. –ß–µ–∫–∞—î–º–æ –Ω–∞ –ø–µ—Ä—à–∏—Ö –ø–∞—Ü—ñ—î–Ω—Ç—ñ–≤.")
else:
    patient_view.show_dashboard(df)
